
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Chen Rui&#39;s Blog">
    <title>Chen Rui&#39;s Blog</title>
    <meta name="author" content="">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"Website","@id":"https://crotoc.github.io","author":{"@type":"Person","name":null,"sameAs":["https://github.com/","http://stackoverflow.com/users","https://twitter.com/","https://facebook.com/","https://plus.google.com/","https://www.linkedin.com/profile/","mailto"]},"name":"Chen Rui's Blog","description":null,"url":"https://crotoc.github.io"}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Chen Rui&#39;s Blog">
<meta property="og:url" content="https://crotoc.github.io/index.html">
<meta property="og:site_name" content="Chen Rui&#39;s Blog">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chen Rui&#39;s Blog">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Chen Rui&#39;s Blog</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="首页">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="分类">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="标签">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" title="归档">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="#search" title="搜索">
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="关于">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="http://stackoverflow.com/users" target="_blank" rel="noopener" title="Stack Overflow">
                    
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://twitter.com/" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://facebook.com/" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://plus.google.com/" target="_blank" rel="noopener" title="Google Plus">
                    
                        <i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google Plus</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://www.linkedin.com/profile/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/mailto" title="邮箱">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/atom.xml" title="RSS">
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/03/23/hello-world/">
                            Hello World
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-03-23T01:49:12+08:00">
	
		    3月 23, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/03/23/hello-world/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/03/22/How-to-install-v2ray-service-on-R7800/">
                            How to install v2ray service on R7800
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-03-22T10:22:30+08:00">
	
		    3月 22, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="如何在netgear-R7800上面安装v2ray服务"><a href="#如何在netgear-R7800上面安装v2ray服务" class="headerlink" title="如何在netgear R7800上面安装v2ray服务"></a>如何在netgear R7800上面安装v2ray服务</h1><h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#如何在netgear-R7800上面安装v2ray服务"><span class="toc-text">如何在netgear R7800上面安装v2ray服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#要求"><span class="toc-text">要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署v2ray服务端"><span class="toc-text">部署v2ray服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#v2ray服务器端配置文件"><span class="toc-text">v2ray服务器端配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行v2ray服务端"><span class="toc-text">运行v2ray服务端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端部署"><span class="toc-text">客户端部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#openWRT的安装"><span class="toc-text">openWRT的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译v2ray安装包"><span class="toc-text">编译v2ray安装包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装v2ray"><span class="toc-text">安装v2ray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端配置"><span class="toc-text">客户端配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#填写server"><span class="toc-text">填写server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#翻回国内"><span class="toc-text">翻回国内</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#科学上网"><span class="toc-text">科学上网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动程序"><span class="toc-text">启动程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-text">参考链接</span></a></li></ol></li></ol>
<p>我在前面一篇博客里面写过如何安装ss的服务，由于常用的ss失效（端口被封，ss已经能够被特征识别），所以折腾了一下v2ray。这想这应该也是大势所趋吧。</p>
<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ol>
<li>一台安装了openWRT的路由器，本文使用r7800。</li>
<li>一个可用的v2ray服务器，可以花钱买，也可以自己用虚拟机搭建一个。本文使用自己搭建。</li>
<li>一个ubuntu系统用于编译相关的软件，使v2ray服务可以在router上面运行。</li>
<li>如果部署过ss服务器和客户端，那就完美了</li>
<li>懂一些linux</li>
</ol>
<h2 id="部署v2ray服务端"><a href="#部署v2ray服务端" class="headerlink" title="部署v2ray服务端"></a>部署v2ray服务端</h2><p>这一部分主要参看了这个<a href="https://toutyrater.github.io/prep/install.html" target="_blank" rel="noopener">教程</a>，在这里我只写下主要步骤。</p>
<p>登陆自己需要部署v2ray的服务器，如果是翻回国内就搞个有国内公网ip的虚拟机，如果科学上网，就弄个有国外ip虚拟机。然后下载脚本并且安装：</p>
<pre><code>wget https://install.direct/go.sh
sudo bash go.sh
</code></pre><p>如果其中缺少什么依赖包，就自己安装好。</p>
<h3 id="v2ray服务器端配置文件"><a href="#v2ray服务器端配置文件" class="headerlink" title="v2ray服务器端配置文件"></a>v2ray服务器端配置文件</h3><p>和ss服务器一样，需要针对v2ray写一个配置文件，这是我的。下面我来解释一下配置文件的内容:</p>
<pre><code>{
//设置v2ray的log和orr文件；设置log的level
&quot;log&quot;: {
    &quot;access&quot;: &quot;/home/ruichen/v2ray/v2ray.log&quot;,
    &quot;error&quot;: &quot;/home/ruichen/v2ray/v2ray.err&quot;,
    &quot;loglevel&quot;: &quot;warning&quot;
    },
//服务器端入站包的配置，即代理服务器信息
&quot;inbounds&quot;:[//main port
{
    &quot;port&quot;: 18888,
    &quot;listen&quot;: &quot;0.0.0.0&quot;,
    &quot;protocol&quot;: &quot;vmess&quot;,
    &quot;settings&quot;: {
    &quot;clients&quot;: [
        {
//这里需要一个UUID，可以找网站生成一个，相当于ss的用户名。
        &quot;id&quot;: &quot;67ee3d0e-77c1-4776-8573-82ebc55176f9&quot;,
        &quot;alterId&quot;: 64
        }
    ],
    //因为现在端口被查的厉害，所以我使用了一个随机端口的策略，避免长期使用一个端口容易被封。先建立一个绕行端口的通讯。
    &quot;detour&quot;: { //绕行配置，即指示客户端使用 dynamicPort 的配置通信
        &quot;to&quot;: &quot;dynamicPort&quot;
    }
    },
    //这里的流量协议，我使用简单的kcp，听说比tcp好些
    &quot;streamSettings&quot;: {
        &quot;network&quot;: &quot;kcp&quot;
    }
    },
{
//随机端口的配置
    &quot;protocol&quot;: &quot;vmess&quot;,
    &quot;port&quot;: &quot;18900-19000&quot;, // 端口范围
    &quot;tag&quot;: &quot;dynamicPort&quot;,  // 与上面的 detour to 相同
    &quot;settings&quot;: {
        &quot;default&quot;: {
        &quot;alterId&quot;: 64
    }
    },
    //如何分配随机端口
    &quot;allocate&quot;: {            // 分配模式
        &quot;strategy&quot;: &quot;random&quot;,  // 随机开启
        &quot;concurrency&quot;: 2,      // 同时开放两个端口,这个值最大不能超过端口范围的 1/3
        &quot;refresh&quot;: 3           // 每三分钟刷新一次
    },
    &quot;streamSettings&quot;: {
        &quot;network&quot;: &quot;kcp&quot;
    }
}
],
//服务器端的出站包配置，这里使用freedom，意思就是自动处理进来包的类型
&quot;outbounds&quot;: [{
    &quot;protocol&quot;: &quot;freedom&quot;,
    &quot;settings&quot;: {}
}],
//v2ray自带一个routing的功能，能够将设置的ip或者域名自动的routing。其中outboundTag有三种，这里使用blocked，意思是从这些ip来的通讯全部屏蔽掉，下面主要是本机的私有地址。
&quot;routing&quot;: {
    &quot;strategy&quot;: &quot;rules&quot;,
    &quot;settings&quot;: {
    &quot;rules&quot;: [
        {
        &quot;type&quot;: &quot;field&quot;,
        &quot;ip&quot;: [
            &quot;0.0.0.0/8&quot;,
            &quot;10.0.0.0/8&quot;,
            &quot;100.64.0.0/10&quot;,
            &quot;127.0.0.0/8&quot;,
            &quot;169.254.0.0/16&quot;,
            &quot;172.16.0.0/12&quot;,
            &quot;192.0.0.0/24&quot;,
            &quot;192.0.2.0/24&quot;,
            &quot;192.168.0.0/16&quot;,
            &quot;198.18.0.0/15&quot;,
            &quot;198.51.100.0/24&quot;,
            &quot;203.0.113.0/24&quot;,
            &quot;::1/128&quot;,
            &quot;fc00::/7&quot;,
            &quot;fe80::/10&quot;
        ],
        &quot;outboundTag&quot;: &quot;blocked&quot;
    }
    ]
}
    }
}
</code></pre><p>UUID可以使用<a href="https://www.uuidgenerator.net/" target="_blank" rel="noopener">网站</a>随机生成一个。</p>
<h3 id="运行v2ray服务端"><a href="#运行v2ray服务端" class="headerlink" title="运行v2ray服务端"></a>运行v2ray服务端</h3><p>到这里我们就算配置完成了，首先使用下面命令测试一下config.json是否存在错误：</p>
<pre><code>/usr/bin/v2ray/v2ray -test -config /etc/v2ray/config.json
</code></pre><p>如果顺利通过，就可以运行服务器：</p>
<pre><code>/usr/bin/v2ray/v2ray -config /etc/v2ray/config.json
</code></pre><p>如果想使用systemctl来启动v2ray，需要用你的配置文件替换掉系统中/etc/v2ray/目录下的config.json文件。我这里使用软连接的方式，方便以后修改。</p>
<pre><code>rm /etc/v2ray/config.json
ln -s ~/v2ray/config.json /etc/v2ray/config.json
</code></pre><h2 id="客户端部署"><a href="#客户端部署" class="headerlink" title="客户端部署"></a>客户端部署</h2><p>v2ray比较神奇的地方在于客户端其实使用的是服务端的程序，只是配置文件不同。我这次需要将客户端安装到路由器上。</p>
<h3 id="openWRT的安装"><a href="#openWRT的安装" class="headerlink" title="openWRT的安装"></a>openWRT的安装</h3><p>直接参看前面的<a href="https://crotoc.github.io/2018/09/14/Unblock-Youku-on-a-openWRT-Router/">如何在路由器上安装openwrt</a></p>
<h3 id="编译v2ray安装包"><a href="#编译v2ray安装包" class="headerlink" title="编译v2ray安装包"></a>编译v2ray安装包</h3><p>由于v2ray比较新，是ss被喝茶之后出现的，所以现在openwrt各版本并没有直接的安装包，我这里借用了<a href="https://github.com/coolsnowwolf/lede/tree/master/package/lean" target="_blank" rel="noopener">lean大的lede项目</a>中的v2ray源码包。这个lede项目集成了很多种架构的核心，希望大家的router都能在里面找到。</p>
<p>首先，安装一个ubuntu 64bit，然后lede项目克隆到本地：</p>
<pre><code>git clone https://github.com/coolsnowwolf/lede
</code></pre><p>接着，进入lede目录，更新并安装feeds：</p>
<pre><code>cd lede
./scripts/feeds update -a
./scripts/feeds install -a
</code></pre><p>再接着使用gui界面选择需要编译的路由：</p>
<pre><code>make menuconfig
</code></pre><p>在这个gui界面中，需要做如下选择：</p>
<ol>
<li>Target System下面的Qualcomm Atheros IPQ806X，因为r7800的就是使用的这颗核心。</li>
<li>Network目录下的v2ray需要选上。</li>
<li>LuCI下面的Application下的Include V2ray需要选上。</li>
</ol>
<p>然后编译：</p>
<pre><code>make -j1 V=s 
</code></pre><p>这一步时间很长，其实可以优化，就是在gui界面中吧不需要的东西全部不选。由于我也不知道那些是可以不用的，所以没有来得及研究，只去掉了一些看起来就不相关的东西。</p>
<p>等待这一步结束，使用find命令找到v2ray相关的ipk包：</p>
<pre><code>find ./ -name &quot;*ipk&quot; | grep v2r
</code></pre><p>将这些ipk包scp到路由器中：</p>
<pre><code>scp  ./bin/packages/arm_cortex-a15_neon-vfpv4/base/*v2ray*.ipk root@69.245.0.87:/root/
scp ipset-lists_20181104-1_arm_cortex-a15_neon-vfpv4.ipk root@*.*.*.*:/root/
</code></pre><h3 id="安装v2ray"><a href="#安装v2ray" class="headerlink" title="安装v2ray"></a>安装v2ray</h3><p>这个时候可以ssh登陆路由器，然后安装这些包：</p>
<pre><code>opkg install v2ray_v4.17.0_arm_cortex-a15_neon-vfpv4.ipk
opkg install luci-app-v2ray-pro_1.0-11_all.ipk
opkg install luci-i18n-v2ray-pro-zh-cn_1.0-11_all.ipk
</code></pre><p>注意安装过程中会各种报错，主要就是依赖包问题，比如dnsmasq，ipset，ipset-list，pdnsd-alt等，这是可以直接使用路由器的源安装，如</p>
<pre><code>opkg install dnsmasq
opkg install ipset
</code></pre><p>如果在源中找不到那么就从刚刚编译的里面找了之后安装：</p>
<pre><code>find ./ -name &quot;*ipk&quot; | grep ipset-list
find ./ -name &quot;*ipk&quot; | grep pdnsd-alt
</code></pre><p>没有报错就算安装成功。</p>
<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>因为本文中安装了v2ray的luci版本，所以可以直接在luci界面的Service下找到V2Ray Pro，然后填写设置。</p>
<h4 id="填写server"><a href="#填写server" class="headerlink" title="填写server"></a>填写server</h4><p>把Server Setting中的服务器地址，端口，id（这里填上文服务器端配置中的uuid），alter ID ，都填上保存。</p>
<h4 id="翻回国内"><a href="#翻回国内" class="headerlink" title="翻回国内"></a>翻回国内</h4><p>把Base Setting中的proxy mode改成Overseas Users watch China…，这是进入到unbluck-youku模式。</p>
<p>比较遗憾的一点是luci中并没有可以定制unblock-youku站点的地方。所以我们可以通过修改配置文件或者自动更新配置文件的方式达成。</p>
<p>配置文件的路径是/etc/gfwlist/unblock-youku，可以把需要的网址和ip填在其中，这样重启客户端就可以正常使用了。</p>
<ol>
<li>手动添加方式</li>
</ol>
<p>比如现在163音乐需要代理的网址是nos.netease.com，将这一条加入到/etc/gfwlist/unblock-youku文件中就可以了</p>
<ol start="2">
<li>自动添加方式</li>
</ol>
<p>做一个需要代理网址的的链接。我这里使用的是我常用的<a href="https://crotoc.github.io/2019/01/22/Unblock-region-restriction-of-musics-videos/unblock.rules.v2ray.dnsmasq.conf">链接</a>，只对163音乐，qq音乐，腾讯视频和android tv端的云极光起作用。ipset的使用方法请自己找相关的文章。</p>
<p>然后修改/etc/init.d/v2ray。这个文件是主程序文件，里面写了如何调用ipset列表以及iptables的路由转发方式。我这里不详细的写了。在这个主程序文件的start函数中加入几行：</p>
<pre><code>case &quot;$vt_proxy_mode&quot; in
    M|V)
        awk &apos;!/^$/&amp;&amp;!/^#/{printf(&quot;ipset=/%s/&apos;&quot;$vt_gfwlist&quot;&apos;\n&quot;,$0)}&apos; \
            /etc/gfwlist/$vt_gfwlist &gt; /var/etc/dnsmasq-go.d/02-ipset.conf

        ##############################################################################
        #####这里开始插入。 意思就是说下载上面那个链接的conf文件然后放到dnsmasq的配置文件家中。
        echo &quot;Coping my conf&quot;
        wget https://crotoc.github.io/2019/01/22/Unblock-region-restriction-of-musics-videos/unblock.rules.v2ray.dnsmasq.conf \
            -O /var/etc/dnsmasq-go.d/unblock.rules.v2ray.dnsmasq.conf 2&gt;/dev/null
        ##############################################################################
</code></pre><p>这样每次启动服务的时候，程序会自动下载某一个链接，用于dnsmasq的配置。</p>
<ol start="3">
<li>自动添加方式-其他的可能</li>
</ol>
<p>上面修改v2ray脚本的方式比较暴力，其实这一步我们要实现的东西就是将需要代理的网址和ip放到ipset的unblock-youku中，这样dnsmasq回去自动处理它。所以只要是能达到这个目的的都可以。</p>
<h4 id="科学上网"><a href="#科学上网" class="headerlink" title="科学上网"></a>科学上网</h4><p>在luci的base setting中选base on gfw-list模式，然后路由会自动调用/etc/gfwlist/china-banned文件中的地址。gfw代理模式可以很方便的在luci界面中自定义。这里不在多说。</p>
<h4 id="启动程序"><a href="#启动程序" class="headerlink" title="启动程序"></a>启动程序</h4><p>现在全部设置好了就可以启动程序了：</p>
<pre><code>/etc/init.d/v2ray start
</code></pre><p>如果list有什么改动，那么就stop在start</p>
<p>如果v2ray启动中，luci里面会显示V2Ray Pro RUNNING</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>如果大家不愿意通过luci去设置v2ray的客户端，那么也可以直接ssh到路由器上面启动。大概的步骤是：</p>
<ol>
<li>写个客户端的config文件</li>
<li>建立一个ipset的table</li>
<li>写个iptables的链</li>
</ol>
<p>这套流程里面最简单的方式可能是直接修改/etc/init.d/v2ray中的start程序中的启动行，将客户端config文件传进去即可。/etc/init.d/v2ray的主要任务就是我上面说的三条。任何一个任务都是可以修改的。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在路由器是ping某一个在列表中的地址，比如：</p>
<pre><code>ping v.youku.com
</code></pre><p>然后使用ipset查看unblock-youku列表：</p>
<pre><code>ipset list
</code></pre><p>如果上面的ip出现在unblock-youku列表中，那么ipset正确识别了需要代理的链接。</p>
<p>然后在服务器端看日志，如果可以看到相关链接的日志，那么就大功告成。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://toutyrater.github.io/" target="_blank" rel="noopener">V2Ray 配置指南|V2Ray 白话文教程</a><br><a href="https://github.com/coolsnowwolf/lede" target="_blank" rel="noopener">lean大的lede项目</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/03/22/How-to-install-v2ray-service-on-R7800/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/03/16/Bugs-when-using-the-tranquilpeak-hexo-theme/">
                            Bugs when using the tranquilpeak hexo theme
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-03-16T01:48:20+08:00">
	
		    3月 16, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>今天想将blog的主题从next 换成tranquilpeak,结果发现了很多的问题,这里记录一下:</p>
<ol>
<li><p>因为我使用travis自动在线部署,所以主题里面的node_modules不是必须的.</p>
</li>
<li><p>这个主题的.gitignore文件中自动略去了assets文件夹,导致了网站看不到格式,只有文字.</p>
</li>
<li><p>需要将主题中的package.json里面的dependencies拷贝到主目录的package.json才能在travis端自动安装.</p>
</li>
<li><p>需要在主目录的_config.yml中设置language,不然出现的是德语.其中语言设置必须与主题中languages目录下的文件名对应.</p>
</li>
</ol>
<h2 id="标准调试过程"><a href="#标准调试过程" class="headerlink" title="标准调试过程"></a>标准调试过程</h2><p>为了加快下一次的调试,经验如下:</p>
<h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>本地安装包,找出依赖的问题:</p>
<pre><code>npm install
</code></pre><h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p>生成本地public目录:</p>
<pre><code>hexo clean
hexo g
hexo s
</code></pre><p>用本地浏览器打开确定本地显示是否出错:</p>
<pre><code>localhost:4000
</code></pre><p>如果本地没错可以将这个本地版本git到remote端,使用网页链接查看是否有错.</p>
<p>如果有错则核对两次commit之间的偏差,确定问题所在.</p>
<p>在本次调试过程中,主要问题是assets文件夹被主题目录中的.gitignore忽略,这样网页只有文字没有样式.</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/03/16/Bugs-when-using-the-tranquilpeak-hexo-theme/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/01/22/Unblock-region-restriction-of-musics-videos/">
                            Unblock region restriction of musics/videos
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-01-22T10:16:24+08:00">
	
		    1月 22, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>I try to capture the link for qq video, music and netease music. The file is at below:</p>
<a href="/2019/01/22/Unblock-region-restriction-of-musics-videos/unblock.rules.txt" title="Unblock rules">Unblock rules</a>
<a href="/2019/01/22/Unblock-region-restriction-of-musics-videos/unblock.rules.dnsmasq.conf" title="Unblock rules for dnsmasq on openWRT router">Unblock rules for dnsmasq on openWRT router</a>
<a href="/2019/01/22/Unblock-region-restriction-of-musics-videos/unblock.rules.v2ray.dnsmasq.conf" title="Unblock rules of v2ray for dnsmasq on openWRT router">Unblock rules of v2ray for dnsmasq on openWRT router</a>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/01/22/Unblock-region-restriction-of-musics-videos/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/01/22/terminal-in-windows-sub-linux-system/">
                            Windows 10下面最好的terminal (WSL)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-01-22T10:16:24+08:00">
	
		    1月 22, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Windows-10下面最好的terminal-WSL"><a href="#Windows-10下面最好的terminal-WSL" class="headerlink" title="Windows 10下面最好的terminal (WSL)"></a>Windows 10下面最好的terminal (WSL)</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>我主要的工作都在linux的服务器上,所以有个好用的终端非常重要.我使用过的终端非常多,包括了最简单的putty,稍微复杂一些的cygwin,然后是基于cmder的Conmu.他们各有个的优点:</p>
<ol>
<li>Putty贵在简单,只要能连上服务器就行,但是问题在于有的时候没有服务器我没法运行linux命令.</li>
<li>cygwin是个很好的windows下面的linux系统,也有很多的插件可以开发,但是终端实在太难看了.我尝试过使用mintty作为前端,但是用过一两年之后还是弃用了,因为它对linux的原生命令支持的不好.</li>
<li>ConEmu是我最满意的终端系统之一,但是后来出现了一个bug毁掉一切.那就是连到服务器上的时候,我使用emacs的分屏功能,中间的分隔会是不是的抽风,将一切变成乱码.作为一个常年使用emacs的人,这也是接受不能.</li>
<li>其他.</li>
</ol>
<p>后来Windows 10系统集成了Windows sublinux系统实在太符合我的胃口了.作为一个使用过ubuntu系统作为主系统的人,简直对在windows上面运行ubuntu的诱惑无法抵御,于是我掉坑里了.</p>
<h2 id="安装WSL"><a href="#安装WSL" class="headerlink" title="安装WSL"></a>安装WSL</h2><p>这不是重点,贴个链接在此.<a href="https://www.cnblogs.com/JettTang/p/8186315.html" target="_blank" rel="noopener">WSL的安装和使用</a></p>
<h2 id="安装X-windows"><a href="#安装X-windows" class="headerlink" title="安装X windows"></a>安装X windows</h2><p>WSL可以使用windows的powershell,但是对于这个终端我实在无爱,所以后来我选中了ubuntu的里面的原生linux终端terminator.那么首要的问题是如何在windows上面运行x windows的应用.这里有两个选择,一个是<a href="https://sourceforge.net/projects/vcxsrv/" target="_blank" rel="noopener">VcXsrv</a>,一个是<a href="https://sourceforge.net/projects/xming/" target="_blank" rel="noopener">Xming</a>. </p>
<p>我选择了XcXsrv, 大体步骤就是下载安装文件安装,这里不详述.</p>
<h2 id="配置terminator"><a href="#配置terminator" class="headerlink" title="配置terminator"></a>配置terminator</h2><p>安装了xwindows之后就可以打开WSL,安装terminator:</p>
<pre><code>sudo apt-get install terminator
</code></pre><h2 id="命令行启动"><a href="#命令行启动" class="headerlink" title="命令行启动"></a>命令行启动</h2><p>打开命令行工具,然后输入下面命令:</p>
<pre><code>bash -c -l &quot;DISPLAY=:0 terminator &amp;&quot;
</code></pre><h2 id="快捷方式启动"><a href="#快捷方式启动" class="headerlink" title="快捷方式启动"></a>快捷方式启动</h2><p>为了让terminator看起来像个程序一样启动,还需要一些其他的工作.</p>
<p>首先在ubuntu里面写一个脚本叫做<a href="./terminal-in-windows-sub-linux-system/terminator.sh">terminator.sh</a>.这个脚本主要为了实现自动检测打开x window服务器:</p>
<pre><code>#!/bin/sh
cd ~

## 检查windows系统当前的进程里面是否有vcxsrv.exe.如果有代表x windows已经开启,如果没有则开启
x=`/mnt/c/Windows/System32/tasklist.exe /FI &quot;IMAGENAME eq vcxsrv.exe&quot; | grep vcxsrv.exe`;

if [[ ! \$x ]];then

&quot;/mnt/c/Program Files/VcXsrv/vcxsrv.exe&quot; :0 -ac -terminate -lesspointer -multiwindow -clipboard -wgl -dpi auto 2&gt; /dev/null &amp; 
fi
##将x windows的显示定在本地.
export DISPLAY=:0.0

##启动 terminator
terminator
</code></pre><p>然后在windows下面边写一个快捷方式脚本<a href="./terminal-in-windows-sub-linux-system/startTerminator.vbs">startTerminator,vbs</a>,这个脚本主要用于实现建立快捷方式打开terminator:</p>
<pre><code>&apos; 将运行服务器上的terminator.sh脚本存成一个参数变量
args = &quot;-c&quot; &amp; &quot; -l &quot; &amp; &quot;&quot;&quot;bash ~/SHscript/terminator.sh&quot;&quot;&quot;


&apos; windows自动运行脚本，用上面的arg作为参数
WScript.CreateObject(&quot;Shell.Application&quot;).ShellExecute &quot;bash&quot;, args, &quot;&quot;, &quot;open&quot;, 0
</code></pre><p>然后在桌面建立一个快捷方式,在目标里面写上C:\Users\chenr6\Downloads\startTerminator.vbs,图标改成自己喜欢的样子.双击就可以打开了.</p>
<h1 id="如何使用中文输入法"><a href="#如何使用中文输入法" class="headerlink" title="如何使用中文输入法"></a>如何使用中文输入法</h1><p>首先我选择搜狗输入法,因为我想使用双拼,而且我在windows下面的输入法就是搜狗.</p>
<h2 id="安装fcitx框架"><a href="#安装fcitx框架" class="headerlink" title="安装fcitx框架"></a>安装fcitx框架</h2><p>搜狗输入法的linux版本输入法需要fcitx框架,所以首先安装框架:</p>
<pre><code>sudo apt-get update
sudo apt-get install fcitx
sudo apt-get install fcitx-config-gtk
sudo apt-get install fcitx-table-all
sudo apt-get install im-switch
</code></pre><p>然后下载<a href="https://pinyin.sogou.com/linux/?r=pinyin" target="_blank" rel="noopener">搜狗linux最新版deb包</a>,并且安装:</p>
<pre><code>sudo dpkg -i sogouxxx.deb
</code></pre><p>如果需要输入法设置软件的界面中文,生成中文locale:</p>
<pre><code>sudo locale-gen zh_CN.UTF-8
</code></pre><p>将下列</p>
<p>在wsl的.bashrc文件中加入下面的设置:</p>
<pre><code>export XMODIFIERS=@im=fcitx
export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx

if [ \$(ps -ax | grep dbus-daemon | wc -l) -eq 1 ]; then
    eval &apos;dbus-launch &gt; /dev/null 2&gt;&amp;1&apos;
fi
</code></pre><p>打开fcitx设置程序:</p>
<pre><code>fcitx-configtool
</code></pre><p>在里面加入搜狗拼音,并且最好将全局设置中的输入法热键修改一下.重新打开wsl,愉快的使用吧</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.ropnop.com/configuring-a-pretty-and-usable-terminal-emulator-for-wsl/" target="_blank" rel="noopener">terminator参考</a></p>
<p><a href="https://pinyin.sogou.com/linux/?r=pinyin" target="_blank" rel="noopener">搜狗输入法参考</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/01/22/terminal-in-windows-sub-linux-system/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/09/28/Install-customized-fonts-for-imagemagick/">
                            Install customized fonts for imagemagick
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-09-28T23:46:24+08:00">
	
		    9月 28, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Install-customized-fonts-for-imagemagick-7"><a href="#Install-customized-fonts-for-imagemagick-7" class="headerlink" title="Install customized fonts for imagemagick 7"></a>Install customized fonts for imagemagick 7</h1><ol>
<li><p>Download the font, for example, Roboto </p>
<pre><code>wget https://fonts.google.com/download?family=Roboto
</code></pre></li>
<li><p>Download the processing script for fonts</p>
<pre><code>wget http://imagemagick.org/Usage/scripts/imagick_type_gen
chmod +x imagick_type_gen
</code></pre></li>
<li><p>According to the documents of imagemagick 7 (<a href="https://imagemagick.org/script/resources.php)" target="_blank" rel="noopener">https://imagemagick.org/script/resources.php)</a>, ImageMagick is able to load raw TrueType and Postscript font files. It searches for the font configuration file, type.xml, in the following order, and loads them if found:</p>
<pre><code>\$MAGICK_CONFIGURE_PATH
\$MAGICK_HOME/etc/ImageMagick/-7.0.8
\$MAGICK_HOME/share/ImageMagick-7.0.8
\$XDG_CACHE_HOME/ImageMagick
\$HOME/.config/ImageMagick
&lt;client path&gt;/etc/ImageMagick
\$MAGICK_FONT_PATH$
</code></pre></li>
</ol>
<p>So create a dir ~/.config/ImageMagick</p>
<pre><code>mkdir ~/.config/ImageMagick
</code></pre><ol start="4">
<li><p>According the description section  in the script imageick_type_gen, create a xml for your fonts using the processing script:</p>
<pre><code>find /dir/to/font/ -type f -name &apos;*.ttf&apos; | imagick_type_gen -f - &gt; ~/.ImageMagick/type-myfonts.xml
</code></pre></li>
</ol>
<ol start="5">
<li><p>Include the xml in main xml file:</p>
<pre><code>cat &lt;&lt;\EOF &gt;&gt;~/.magick/type.xml
&lt;typemap&gt;
&lt;include file=&quot;type-myfonts.xml&quot; /&gt;
&lt;/typemap&gt;
EOF
</code></pre></li>
<li><p>Check font using the command:</p>
<pre><code>convert -list font
</code></pre></li>
</ol>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/09/28/Install-customized-fonts-for-imagemagick/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/09/25/Modify-the-hotkey-of-Chinese-English-language-switching-in-Windows-10/">
                            Modify the hotkey of Chinese-English language switching in Windows 10
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-09-25T11:51:49+08:00">
	
		    9月 25, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Modify-the-hotkey-of-Chinese-English-language-switching-in-Windows-10"><a href="#Modify-the-hotkey-of-Chinese-English-language-switching-in-Windows-10" class="headerlink" title="Modify the hotkey of Chinese-English language switching in Windows 10"></a>Modify the hotkey of Chinese-English language switching in Windows 10</h1><p>The problem is very annoying because the hotkey ctrl+space has conflicted with others in emacs or other program. My thought is changing it to another combination ctrl+F1.</p>
<ol>
<li>Open regedit</li>
<li>Navigate to HKEY_USER.DEFAULT\Input Method\Hot Keys\00000010\</li>
<li>Modify the Key Modifiers and Virtual Key.</li>
<li><p>Only disable the hotkey is change the first two digits of the two keys in 00.</p>
<pre><code>Key Modifiers: 00 c0 00 00.
Virtual Key: 00 00 00 00
</code></pre></li>
<li><p>For Key modifiers, the rules of the number are like:</p>
<pre><code>__00__ c0 00 00 : The underlining two digits indicate one of modifier keys.

CTRL: 02
ALT: 01
SHIFT: 04
Disable: 00

00 __c0__ 00 00 : The underlining two digits indicate the left or right position on the keybord.

Left: 80
Right: 40
Left or Right: 8+4=12=c0
</code></pre></li>
<li><p>For virtual key, the rules are like:</p>
<pre><code>__00__ 00 00 00 : The hex of ascii of a virtual key.
</code></pre><p> Please see the reference: <a href="https://docs.microsoft.com/en-us/windows/desktop/inputdev/virtual-key-codes" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/desktop/inputdev/virtual-key-codes</a></p>
<p> So if we want F1, the hex code is 70:</p>
<pre><code>__70__ 00 00 00 : The hex of ascii of F1.
</code></pre></li>
<li><p>Restart your computer.</p>
</li>
</ol>
<p>For my case, I just need to modify virtual key to 70 00 00 00</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/09/25/Modify-the-hotkey-of-Chinese-English-language-switching-in-Windows-10/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/09/14/Unblock-Youku-on-a-openWRT-Router/">
                            Unblock Youku on a openWRT Router
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-09-14T10:18:12+08:00">
	
		    9月 14, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="How-to-unblock-youku-on-your-router"><a href="#How-to-unblock-youku-on-your-router" class="headerlink" title="How to unblock youku on your router"></a>How to unblock youku on your router</h1><p>To watched videos from China apps like youku, tencent, sogou, we have to unblock the restrictions put on these website.</p>
<p>I applied this method to two models of routers: NETGEAR WNDR3700 ($20 on ebay) and R7800 ($160 on ebay) and they perform well enough.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ol>
<li>A router that can install openWRT.</li>
<li>A list of urls needed to be unblocked.</li>
<li>A shadowsocks proxy (let me know if you don’t have)</li>
<li>Plenty of time</li>
</ol>
<h2 id="Installation-of-openWRT"><a href="#Installation-of-openWRT" class="headerlink" title="Installation of openWRT"></a>Installation of openWRT</h2><p>The openWRT is a open-source system that can be installed on routers, which can bring many great new functions. It is actively developed and maintained.</p>
<p>For R7800, we need to flash openWRT through tftp.</p>
<p>1) Download the firmware from <a href="https://openwrt.org/toh/hwdata/netgear/netgear_r7800" target="_blank" rel="noopener">https://openwrt.org/toh/hwdata/netgear/netgear_r7800</a>. Remember the right file is with suffix of “.img”</p>
<pre><code>wget http://downloads.openwrt.org/releases/18.06.1/targets/ipq806x/generic/openwrt-18.06.1-ipq806x-netgear_r7800-squashfs-factory.img
</code></pre><p>2) Install tftp on the computer(Ubuntu).</p>
<pre><code>sudo apt-get install tftp
</code></pre><p>3) Let the router enter into recovery mode.</p>
<pre><code>a. Power off the router
b. Keep pressing the reset button using a pin and turn on the router.
c. Release the reset button until the light blink white. The light of router will blink orange first and then after for a few seconds blink white. 
</code></pre><p>4) Connect the computer with router to one of the lan ports and mannually set the ip to 192.168.1.2. Because the router’s ip is 192.168.1.1, don’t use this ip for the computer.</p>
<pre><code>IP: 192.168.1.2
MASK: 255.255.255.0
Gateway: 192.168.1.1
DNS: 192.168.1.1 (Not important)
</code></pre><p>5) Ping the router from the computer to make sure everthing is all right.</p>
<pre><code>ping 192.168.1.1

## 64 bytes from 192.168.1.1: icmp_seq=1 ttl=47 time=80.3 ms
## 64 bytes from 192.168.1.1: icmp_seq=2 ttl=47 time=80.3 ms
## 64 bytes from 192.168.1.1: icmp_seq=3 ttl=47 time=80.3 ms
## 64 bytes from 192.168.1.1: icmp_seq=4 ttl=47 time=80.2 ms
</code></pre><p>6) Connect to the router using tftp and upload the openWRT image.</p>
<pre><code>tftp 192.168.1.1

tftp&gt; ?
Commands may be abbreviated.  Commands are:

connect connect to remote tftp
mode    set file transfer mode
put     send file
get     receive file
quit    exit tftp
verbose toggle verbose mode
trace   toggle packet tracing
status  show current status
binary  set mode to octet
ascii   set mode to netascii
rexmt   set per-packet retransmission timeout
timeout set total retransmission timeout
?       print help information
</code></pre><p>   Change to binary mode. This step is necessary. </p>
<pre><code>tftp&gt; binary
</code></pre><p>   Upload the openWRT img file.</p>
<pre><code>tftp&gt; put openwrt-18.06.1-ipq806x-netgear_r7800-squashfs-factory.img
</code></pre><p>   It will show the size uploaded.</p>
<p>   Quit tftp.</p>
<pre><code>tftp&gt; quit
</code></pre><p>7) If everything goes well, the blinking white light will turn off and the router will restart with openWRT.</p>
<h2 id="Install-shadowsocks-packages"><a href="#Install-shadowsocks-packages" class="headerlink" title="Install shadowsocks packages"></a>Install shadowsocks packages</h2><p>After restarting, the router is running openWRT and we can connect to the router using luci.</p>
<p>Input 192.168.1.1 in a browser and it will ask you to set a password. After this we can connect to the router using ssh with the password.</p>
<pre><code>ssh root@192.168.1.1
</code></pre><p>To install shdowsocks, we need use the package manager command. First refresh the package list by:</p>
<pre><code>opkg update
</code></pre><p>Then find all the packages related to shawdowsocks.</p>
<pre><code>opkg find &quot;*shadowsocks*&quot;
opkg install shadowsocks-client

## Must
opkg install shadowsocks-libev-config

## Not necessary
opkg install shadowsocks-libev-ss-local

## Redirect requests to shadowsocks server)
opkg install shadowsocks-libev-ss-redir 

## Build up rules to redirect)
opkg install shadowsocks-libev-ss-rules 

## ss server, not necessary
opkg install shadowsocks-libev-ss-server

## For DNS requests, not necessary in this case
opkg install shadowsocks-libev-ss-tunnel

##To simple your life
opkg install luci-app-shadowsocks
</code></pre><p>This method needs dnsmasq and ipset to build a ip filter.</p>
<p>The dnsmasq installed by the image does not support ipset, so we need to install dnsmasq-full</p>
<pre><code>opkg remove dnsmasq
opkg install dnsmasq-full
</code></pre><p>I believe ipset package is already installed with shadowsocks. We can validate it by:</p>
<pre><code>opkg install ipset
</code></pre><h2 id="Configurations-of-shadowsocks"><a href="#Configurations-of-shadowsocks" class="headerlink" title="Configurations of shadowsocks"></a>Configurations of shadowsocks</h2><p>I would like to configure shadowsocks using luci, which can save you a lot of time.</p>
<ol>
<li>Add a ss proxy server.</li>
<li>Add a ss-redir service.</li>
<li>The key part is putting the url list to the place that is to be forward to ss proxy server.</li>
<li>Because the step 3 needs to add the url to the related ipset hash when starting the service, so it doesn’t allow any bad urls. Or the service can not start. To overcome this flaw, I modified the /usr/bin/ss-rules by adding a new ipset hash set named “_unblock” and build a new iptable rules to this set.</li>
</ol>
<p>If you don’t want to revise the ss-rules, you can use the command bellow.</p>
<h2 id="configuratins-of-ipset-and-iptables"><a href="#configuratins-of-ipset-and-iptables" class="headerlink" title="configuratins of ipset and iptables"></a>configuratins of ipset and iptables</h2><p>Initiate a new ipset</p>
<pre><code>ipset -N _unblock hash:ip
</code></pre><p>Add the following iptable rules to iptable:</p>
<pre><code>## Create shadowsocks router rules
iptables -t nat -N shadowsocks
iptables -t mangle -N shadowsocks

iptables -t nat -A shadowsocks -d x.x.x.x -j RETURN 
# x.x.x.x为shadowsocks服务器地址
iptables -t nat -A shadowsocks -d 0.0.0.0/8 -j RETURN
iptables -t nat -A shadowsocks -d 10.0.0.0/8 -j RETURN
iptables -t nat -A shadowsocks -d 127.0.0.0/8 -j RETURN
iptables -t nat -A shadowsocks -d 169.254.0.0/16 -j RETURN
iptables -t nat -A shadowsocks -d 172.16.0.0/12 -j RETURN
iptables -t nat -A shadowsocks -d 192.168.0.0/16 -j RETURN
iptables -t nat -A shadowsocks -d 224.0.0.0/4 -j RETURN
iptables -t nat -A shadowsocks -d 240.0.0.0/4 -j RETURN

## TCP
iptables -t nat -A shadowsocks -p tcp -m set --match-set _unblock_ dst -j REDIRECT --to-port 1080

## UDP using TPROXY
iptables -t mangle -A shadowsocks -p udp -m set --match-set redir dst ! --dport 53 -j TPROXY --on-port 1080 --tproxy-mark 0x01/0x01
ip route add local default dev lo table 100
ip rule add fwmark 0x01/0x01 lookup 100
ip route list table 100


iptables -t nat -A PREROUTING -p tcp -j shadowsocks
iptables -t mangle -A PREROUTING -j shadowsocks

iptables -t nat -A OUTPUT -p tcp -j shadowsocks
iptables -t mangle -A OUTPUT -j shadowsocks
</code></pre><h2 id="Configuration-of-dnsmasq-full"><a href="#Configuration-of-dnsmasq-full" class="headerlink" title="Configuration of dnsmasq-full"></a>Configuration of dnsmasq-full</h2><p>Add a conf dir to be loaded by dnsmasq</p>
<pre><code>echo &quot;conf-dir=/etc/dnsmasq.d&quot;&gt;&gt;/etc/dnsmasq.conf
mkdir /etc/dnsmasq.d
cd /etc/dnsmasq.d
touch redir_test.conf
</code></pre><p>Restart dnsmasq after revising config file every time</p>
<pre><code>/etc/init.d/dnsmasq restart
</code></pre><h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><pre><code>netstat -nlp

## listen to the port to see what kind of url 
tcpdump -i br-lan host xxxxx

## Test ipset
ping xxxx
ipset list
</code></pre><h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="http://blog.kompaz.win/2017/03/24/OpenWRT%20Shadowsocks+GFWList%20%E6%B5%81%E9%87%8F%E8%87%AA%E5%8A%A8%E5%88%86%E6%B5%81/" target="_blank" rel="noopener">http://blog.kompaz.win/2017/03/24/OpenWRT%20Shadowsocks+GFWList%20%E6%B5%81%E9%87%8F%E8%87%AA%E5%8A%A8%E5%88%86%E6%B5%81/</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/09/14/Unblock-Youku-on-a-openWRT-Router/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/09/11/rmarkdown-config/">
                            Setup rmarkdown on server without Rstudio
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-09-11T14:03:45+08:00">
	
		    9月 11, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="How-to-Setup-rmarkdown-on-server-without-Rstudio"><a href="#How-to-Setup-rmarkdown-on-server-without-Rstudio" class="headerlink" title="How to Setup rmarkdown on server without Rstudio"></a>How to Setup rmarkdown on server without Rstudio</h1><h2 id="Install-texlive"><a href="#Install-texlive" class="headerlink" title="Install texlive"></a>Install texlive</h2><p>Because the server is centos6 and the glibc is too old to support texlive 2018, I downloaded texlive 2017 from a website.</p>
<pre><code>wget http://ftp.math.utah.edu/pub/tex/historic/systems/texlive/2017/texlive2017-20170524.iso
</code></pre><p>Mount the iso and then cp the files to a dir, cd to the dir and them install a minimal distribute using the command:</p>
<pre><code>cd ~/chenr6/download/texlive
./install-tl --gui=text
</code></pre><p>If you want to install to a specific dir:</p>
<pre><code>export TEXLIVE_INSTALL_PREFIX=/your/dir/
</code></pre><p>Input capital S to select scheme and input lower case d to select basic scheme:</p>
<pre><code>Select scheme:

a [ ] full scheme (everything)
b [ ] medium scheme (small + more packages and languages)
c [ ] small scheme (basic + xetex, metapost, a few languages)
d [X] basic scheme (plain and latex)
e [ ] minimal scheme (plain only)
f [ ] ConTeXt scheme
g [ ] GUST TeX Live scheme
h [ ] infrastructure-only scheme (no TeX at all)
i [ ] teTeX scheme (more than medium, but nowhere near full)
j [ ] custom selection of collections

Actions: (disk space required: 157 MB)
&lt;R&gt; return to main menu
&lt;Q&gt; quit

Enter letter to select scheme: d
</code></pre><p>Input R to return</p>
<p>Input O to ignore the installation of document:</p>
<pre><code>Options customization:

&lt;P&gt; use letter size instead of A4 by default: [ ]
&lt;E&gt; execution of restricted list of programs: [X]
&lt;F&gt; create format files:                      [X]
&lt;D&gt; install font/macro doc tree:              [ ]
&lt;S&gt; install font/macro source tree:           [ ]
&lt;L&gt; create symlinks in standard directories:  [ ]
binaries to: 
manpages to: 
info to: 
&lt;Y&gt; after installation, get package updates from CTAN: [X]

Actions: (disk space required: 157 MB)
&lt;R&gt; return to main menu
&lt;Q&gt; quit

Enter command: 
</code></pre><p>Input R to return and Input I to begin the installation</p>
<h2 id="Setup-texlive"><a href="#Setup-texlive" class="headerlink" title="Setup texlive"></a>Setup texlive</h2><p>After installation, put the binary dir to your PATH:</p>
<pre><code>export PATH=$PATH:/your/dir/to/bin/
</code></pre><p>To avoide to use the local repository, which is default, set a online repository:</p>
<pre><code>tlmgr option repository http://mirror.ctan.org/systems/texlive/tlnet
</code></pre><p>Install the missing packages by using the command:</p>
<pre><code>tlmgr list ecrm2074

    Packages containing files matching crm2074&apos;:
    ec:
        texmf-dist/fonts/source/jknappen/ec/ecrm2074.mf
        texmf-dist/fonts/tfm/jknappen/ec/ecrm2074.tfm
</code></pre><p>The package including ecrm2074 is ec, so use the command:</p>
<pre><code>tlmgr install ec
</code></pre><p>If you want to install the package to a specific dir:</p>
<pre><code>export TEXMFHOME=/your/dir/
</code></pre><p>## </p>
<p>Test your installation by compile a pdf using:</p>
<pre><code>pdflatex your.tex
</code></pre>
                    
                        

                    
                    
                        <p>
                            <a href="/2018/09/11/rmarkdown-config/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/08/10/gnu-join/">
                            Gnu join - join two files by specified field
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-08-10T12:36:45+08:00">
	
		    8月 10, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="How-to-join-multiple-files-using-GNU-join"><a href="#How-to-join-multiple-files-using-GNU-join" class="headerlink" title="How to join multiple files using GNU join"></a>How to join multiple files using GNU join</h1><h2 id="Basic-usage"><a href="#Basic-usage" class="headerlink" title="Basic usage"></a>Basic usage</h2><p>Create two files with <em>TAB</em> delimiter</p>
<p>file1:</p>
<pre><code>a    1
b   1
d       1
e       1
g       1
</code></pre><p>file2:</p>
<pre><code>a   2
b   2
c   2
e   2
f   2
</code></pre><p>Join them use join:</p>
<pre><code>join -1 1 -2 1 file1 file2
</code></pre><p>Output:</p>
<pre><code>a 1 2
d 1 2
e 1 2
</code></pre><h2 id="The-very-useful-options-for-GNU-join"><a href="#The-very-useful-options-for-GNU-join" class="headerlink" title="The very useful options for GNU join"></a>The very useful options for GNU join</h2><h3 id="a1-print-unmatched-lines-in-file1"><a href="#a1-print-unmatched-lines-in-file1" class="headerlink" title="-a1 - print unmatched lines in file1;"></a>-a1 - print unmatched lines in file1;</h3><pre><code>join -1 1 -1 1 file1 file2 -a1
</code></pre><p>Output:</p>
<pre><code>a 1 2
b 1
d 1 2
e 1 2
g 1
</code></pre><h3 id="a2-print-unmatched-lines-in-file2"><a href="#a2-print-unmatched-lines-in-file2" class="headerlink" title="-a2 - print unmatched lines in file2"></a>-a2 - print unmatched lines in file2</h3><pre><code>join -1 1 -1 1 file1 file2 -a2
</code></pre><p>Output:</p>
<pre><code>a 1 2
c 2
d 1 2
e 1 2
f 2
</code></pre><h3 id="a1-a2-print-unmatched-lines-in-both-file1-and-file2"><a href="#a1-a2-print-unmatched-lines-in-both-file1-and-file2" class="headerlink" title="-a1 -a2 - print unmatched lines in both file1 and file2"></a>-a1 -a2 - print unmatched lines in both file1 and file2</h3><pre><code>join  -1 1 -1 1 file1 file2 -a1 -a2
</code></pre><p>Output:</p>
<pre><code>a 1 2
b 1
c 2
d 1 2
e 1 2
f 2
g 1
</code></pre><p><em>Be careful that tab is not aligned well.</em></p>
<h3 id="o-To-align-the-output-in-table-format-use-the-option-to-custome-the-output"><a href="#o-To-align-the-output-in-table-format-use-the-option-to-custome-the-output" class="headerlink" title="-o - To align the output in table format, use the option to custome the output"></a>-o - To align the output in table format, use the option to custome the output</h3><pre><code>join  -1 1 -1 1 file1 file2 -a1 -a2 -o 0,1.2,2.2
</code></pre><p><em>0</em>  means the joined column.<br><em>1.2</em> means print the column 2 in file1;<br><em>2.2</em> means print the column 2 in file2;</p>
<p>Output:</p>
<pre><code>a 1 2
b 1 
c  2
d 1 2
e 1 2
f  2
g 1 
</code></pre><p>If file1 and files have more than 2 columns, modify the -o string</p>
<h3 id="t-To-use-the-TAB-as-output-delimiter"><a href="#t-To-use-the-TAB-as-output-delimiter" class="headerlink" title="-t - To use the TAB as output delimiter"></a>-t - To use the <em>TAB</em> as output delimiter</h3><pre><code>join  -1 1 -1 1 file1 file2 -a1 -a2 -o 0,1.2,2.2 -t$&apos;\t&apos;
</code></pre><p>Output:</p>
<pre><code>a       1       2
b       1
c               2
d       1       2
e       1       2
f               2
g       1
</code></pre><h3 id="–check-order-join-requires-the-input-file-sorted-if-join-with-1st-column-please-sort-the-input-files-using-1st-columns-before-use-join-And-to-make-sure-there-is-no-problem-use-this-option-to-check"><a href="#–check-order-join-requires-the-input-file-sorted-if-join-with-1st-column-please-sort-the-input-files-using-1st-columns-before-use-join-And-to-make-sure-there-is-no-problem-use-this-option-to-check" class="headerlink" title="–check-order -  join requires the input file sorted, if join with 1st column, please sort the input files using 1st columns before use join. And to make sure there is no problem, use this option to check."></a>–check-order -  join requires the input file sorted, if join with 1st column, please sort the input files using 1st columns before use join. And to make sure there is no problem, use this option to check.</h3><pre><code>join  -1 1 -1 1 file1 file2 -a1 -a2 -o 0,1.2,2.2 -t$&apos;\t&apos; --check-order
</code></pre><p>Output:</p>
<pre><code>a       1       2
b       1
c               2
d       1       2
e       1       2
f               2
g       1
</code></pre><p>Create non-sorted file3:</p>
<pre><code>a       3
d       3
c       3
e       3
f       3
</code></pre><p>join file1 and file3:</p>
<pre><code>join  -1 1 -1 1 file1 file3 -a1 -a2 -o 0,1.2,2.2 -t$&apos;\t&apos; --check-order
</code></pre><p>Output with error message:</p>
<pre><code>a       1       3
b       1
join: file3:3: is not sorted: c 3
</code></pre><h3 id="e-To-make-the-output-format-more-strict-and-use-this-option-to-fill-missing-columns-This-helps-greatly-if-you-need-to-process-the-file-in-the-downstreaming-analysis"><a href="#e-To-make-the-output-format-more-strict-and-use-this-option-to-fill-missing-columns-This-helps-greatly-if-you-need-to-process-the-file-in-the-downstreaming-analysis" class="headerlink" title="-e -  To make the output format more strict and use this option to fill missing columns. This helps greatly if you need to process the file in the downstreaming analysis."></a>-e -  To make the output format more strict and use this option to fill missing columns. This helps greatly if you need to process the file in the downstreaming analysis.</h3><pre><code>join  -1 1 -1 1 file1 file2 -a1 -a2 -o 0,1.2,2.2 -t$&apos;\t&apos; --check-order -eNULL
</code></pre><p>Output:</p>
<pre><code>a       1       2
b       1       NULL
c       NULL    2
d       1       2
e       1       2
f       NULL    2
g       1       NULL
</code></pre><p>Output is a very tidy table.</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/08/10/gnu-join/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/page/2/">
              <span>下一页</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">第 1 页 共 2 页</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 null. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name"></h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
